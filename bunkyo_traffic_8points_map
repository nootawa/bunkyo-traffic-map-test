<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñá‰∫¨Âå∫ ÈÅìË∑Ø‰∫§ÈÄö„Çª„É≥„Çµ„Çπ 2015Âπ¥‚Üí2021Âπ¥ ÊØîËºÉÂú∞Âõ≥Ôºà8Âú∞ÁÇπÁâàÔºâ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        #info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        #controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: #333;
        }
        
        select, button {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select {
            background: white;
            color: #333;
        }
        
        button {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        #mapContainer {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
            cursor: move;
        }
        
        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            font-size: 12px;
            z-index: 1000;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid rgba(0,0,0,0.2);
        }
        
        #zoomControls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .zoom-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        
        #tooltip {
            position: absolute;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            pointer-events: none;
            display: none;
            z-index: 2000;
            max-width: 320px;
            font-size: 12px;
        }
        
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #667eea;
            font-size: 14px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 2px 0;
        }
        
        .tooltip-label {
            color: #666;
        }
        
        .tooltip-value {
            font-weight: 600;
            color: #333;
        }
        
        .change-negative {
            color: #1976d2;
        }
        
        .data-note {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }
        
        #summary {
            background: white;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .summary-item {
            display: inline-block;
            margin-right: 30px;
        }
        
        .summary-label {
            color: #666;
            margin-right: 5px;
        }
        
        .summary-value {
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>üöó Êñá‰∫¨Âå∫ ÈÅìË∑Ø‰∫§ÈÄö„Çª„É≥„Çµ„Çπ 2015Âπ¥‚Üí2021Âπ¥ ÊØîËºÉÂú∞Âõ≥Ôºà8Âú∞ÁÇπÔºâ</h1>
            <div id="info">‰∏ªË¶ÅÈÅìË∑Ø8Âú∞ÁÇπ„ÅÆ‰∫§ÈÄöÈáèÂ§âÂåñ„ÇíÂèØË¶ñÂåñ | „Éá„Éº„Çø„ÇΩ„Éº„Çπ: ÂõΩÂúü‰∫§ÈÄöÁúÅ ÈÅìË∑Ø‰∫§ÈÄö„Çª„É≥„Çµ„Çπ</div>
        </div>
        
        <div id="controls">
            <div class="control-group">
                <label for="yearSelect">Ë°®Á§∫Âπ¥Â∫¶:</label>
                <select id="yearSelect">
                    <option value="2015">Âπ≥Êàê27Âπ¥Â∫¶Ôºà2015Âπ¥Ôºâ</option>
                    <option value="2021">‰ª§Âíå3Âπ¥Â∫¶Ôºà2021Âπ¥Ôºâ</option>
                    <option value="comparison" selected>ÊØîËºÉ„É¢„Éº„ÉâÔºà2015Âπ¥‚Üí2021Âπ¥Ôºâ</option>
                </select>
            </div>
            <button onclick="resetView()">üè† ÂàùÊúüË°®Á§∫„Å´Êàª„Çã</button>
        </div>
        
        <div id="mapContainer">
            <canvas id="map"></canvas>
            
            <div id="legend">
                <div class="legend-title">Âá°‰æãÔºà24ÊôÇÈñì‰∫§ÈÄöÈáèÔºâ</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d73027;"></div>
                    <span>50,000Âè∞‰ª•‰∏ä</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fc8d59;"></div>
                    <span>30,000 - 50,000Âè∞</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fee090;"></div>
                    <span>15,000 - 30,000Âè∞</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #91cf60;"></div>
                    <span>5,000 - 15,000Âè∞</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1a9850;"></div>
                    <span>5,000Âè∞Êú™Ê∫Ä</span>
                </div>
            </div>
            
            <div id="zoomControls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                <button class="zoom-btn" onclick="resetView()">‚åÇ</button>
            </div>
            
            <div id="tooltip"></div>
        </div>
        
        <div id="summary">
            <div class="summary-item">
                <span class="summary-label">Ë°®Á§∫Âú∞ÁÇπÊï∞:</span>
                <span class="summary-value">8Âú∞ÁÇπ</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Âπ≥ÂùáÂ§âÂåñ:</span>
                <span class="summary-value">-696Âè∞ (-5.2%)</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">ÊúÄÂ§ßÊ∏õÂ∞ë:</span>
                <span class="summary-value">Á•ûÁî∞ÁôΩÂ±±Á∑ö -16.5%</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">ÊúÄÂ∞èÊ∏õÂ∞ë:</span>
                <span class="summary-value">ÂçÉ‰ª£Áî∞Á∑¥È¶¨Áî∞ÁÑ°Á∑ö -1.9%</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">„Éá„Éº„Çø:</span>
                <span class="summary-value">ÂÆüÊ∏¨2Âú∞ÁÇπ + Êé®ÂÆö6Âú∞ÁÇπ</span>
            </div>
        </div>
    </div>

    <script>
        const comparisonData = [
            {
                "kukan_no": "13604520100",
                "road_name": "Á•ûÁî∞ÁôΩÂ±±Á∑ö",
                "lat": 35.724702804840746,
                "lon": 139.76372015880844,
                "traffic_2015": 5810,
                "traffic_2021": 4854,
                "change": -956,
                "change_rate": -16.5,
                "small_car_2015": 5278,
                "large_car_2015": 532,
                "small_car_2021": 4442,
                "large_car_2021": 412,
                "lanes": 2,
                "speed_down_2015": 7.5,
                "speed_up_2015": 10.5,
                "speed_down_2021": 7.5,
                "speed_up_2021": 13.5,
                "data_type": "actual"
            },
            {
                "kukan_no": "13400080340",
                "road_name": "ÂçÉ‰ª£Áî∞Á∑¥È¶¨Áî∞ÁÑ°Á∑ö",
                "lat": 35.71115318542135,
                "lon": 139.73125813175756,
                "traffic_2015": 20708,
                "traffic_2021": 20320,
                "change": -388,
                "change_rate": -1.9,
                "small_car_2015": 17882,
                "large_car_2015": 2826,
                "small_car_2021": 17921,
                "large_car_2021": 2399,
                "lanes": 6,
                "speed_down_2015": 14.9,
                "speed_up_2015": 12.8,
                "speed_down_2021": 14.7,
                "speed_up_2021": 11.8,
                "data_type": "actual"
            },
            {
                "kukan_no": "13604370040",
                "road_name": "ÁßãËëâÂéüÈõëÂè∏„É∂Ë∞∑Á∑ö",
                "lat": 35.70959450922939,
                "lon": 139.77164515554966,
                "traffic_2015": 15423,
                "traffic_2021": 15000,
                "change": -423,
                "change_rate": -2.7,
                "lanes": 5,
                "data_type": "estimated"
            },
            {
                "kukan_no": "13403190220",
                "road_name": "Áí∞Áä∂3Âè∑Á∑ö",
                "lat": 35.71997847232879,
                "lon": 139.76870998872516,
                "traffic_2015": 18000,
                "traffic_2021": 17500,
                "change": -500,
                "change_rate": -2.8,
                "lanes": 4,
                "data_type": "estimated"
            },
            {
                "kukan_no": "13300170110",
                "road_name": "ÂõΩÈÅì17Âè∑",
                "lat": 35.71931295827659,
                "lon": 139.755625763968,
                "traffic_2015": 25000,
                "traffic_2021": 24000,
                "change": -1000,
                "change_rate": -4.0,
                "lanes": 6,
                "data_type": "estimated"
            },
            {
                "kukan_no": "13302540020",
                "road_name": "ÂõΩÈÅì254Âè∑",
                "lat": 35.70848401962198,
                "lon": 139.75278131490592,
                "traffic_2015": 22000,
                "traffic_2021": 21000,
                "change": -1000,
                "change_rate": -4.5,
                "lanes": 4,
                "data_type": "estimated"
            },
            {
                "kukan_no": "13604530010",
                "road_name": "Êú¨ÈÉ∑‰∫ÄÊà∏Á∑ö",
                "lat": 35.70784954701915,
                "lon": 139.76529051989178,
                "traffic_2015": 12000,
                "traffic_2021": 11500,
                "change": -500,
                "change_rate": -4.2,
                "lanes": 4,
                "data_type": "estimated"
            },
            {
                "kukan_no": "13403010010",
                "road_name": "ÁôΩÂ±±Á•ùÁî∞Áî∞Áî∫Á∑ö",
                "lat": 35.72313231470474,
                "lon": 139.74842123300368,
                "traffic_2015": 16000,
                "traffic_2021": 15200,
                "change": -800,
                "change_rate": -5.0,
                "lanes": 4,
                "data_type": "estimated"
            }
        ];

        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        
        let zoom = 14;
        let centerLat = 35.7175;
        let centerLon = 139.7525;
        let isDragging = false;
        let dragStartX, dragStartY;
        let offsetX = 0, offsetY = 0;
        let currentMode = 'comparison';
        
        const tileCache = {};
        const TILE_SIZE = 256;
        
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            draw();
        }
        
        function latLonToPixel(lat, lon, zoom) {
            const scale = TILE_SIZE * Math.pow(2, zoom);
            const worldX = (lon + 180) / 360 * scale;
            const worldY = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * scale;
            return { x: worldX, y: worldY };
        }
        
        function pixelToLatLon(x, y, zoom) {
            const scale = TILE_SIZE * Math.pow(2, zoom);
            const lon = x / scale * 360 - 180;
            const n = Math.PI - 2 * Math.PI * y / scale;
            const lat = (180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n))));
            return { lat, lon };
        }
        
        function getTrafficColor(traffic) {
            if (traffic >= 50000) return '#d73027';
            if (traffic >= 30000) return '#fc8d59';
            if (traffic >= 15000) return '#fee090';
            if (traffic >= 5000) return '#91cf60';
            return '#1a9850';
        }
        
        function getTrafficRadius(traffic) {
            const minRadius = 6;
            const maxRadius = 14;
            const minTraffic = 0;
            const maxTraffic = 50000;
            const ratio = Math.min((traffic - minTraffic) / (maxTraffic - minTraffic), 1);
            return minRadius + ratio * (maxRadius - minRadius);
        }
        
        function loadTile(x, y, z) {
            const key = `${z}/${x}/${y}`;
            if (tileCache[key]) return tileCache[key];
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
            tileCache[key] = img;
            
            img.onload = () => draw();
            return img;
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const center = latLonToPixel(centerLat, centerLon, zoom);
            const centerScreenX = canvas.width / 2 + offsetX;
            const centerScreenY = canvas.height / 2 + offsetY;
            
            const topLeft = pixelToLatLon(center.x - centerScreenX / 1, center.y - centerScreenY / 1, zoom);
            const bottomRight = pixelToLatLon(center.x + (canvas.width - centerScreenX) / 1, center.y + (canvas.height - centerScreenY) / 1, zoom);
            
            const tileTopLeft = latLonToPixel(topLeft.lat, topLeft.lon, zoom);
            const tileBottomRight = latLonToPixel(bottomRight.lat, bottomRight.lon, zoom);
            
            const startTileX = Math.floor(tileTopLeft.x / TILE_SIZE);
            const startTileY = Math.floor(tileTopLeft.y / TILE_SIZE);
            const endTileX = Math.floor(tileBottomRight.x / TILE_SIZE);
            const endTileY = Math.floor(tileBottomRight.y / TILE_SIZE);
            
            for (let tileX = startTileX; tileX <= endTileX; tileX++) {
                for (let tileY = startTileY; tileY <= endTileY; tileY++) {
                    const tile = loadTile(tileX, tileY, zoom);
                    if (tile.complete) {
                        const screenX = (tileX * TILE_SIZE - center.x) + centerScreenX;
                        const screenY = (tileY * TILE_SIZE - center.y) + centerScreenY;
                        ctx.drawImage(tile, screenX, screenY, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
            
            drawMarkers();
        }
        
        function drawMarkers() {
            comparisonData.forEach(point => {
                const pos = latLonToPixel(point.lat, point.lon, zoom);
                const center = latLonToPixel(centerLat, centerLon, zoom);
                const x = (pos.x - center.x) + canvas.width / 2 + offsetX;
                const y = (pos.y - center.y) + canvas.height / 2 + offsetY;
                
                let traffic, color, radius;
                
                if (currentMode === '2015') {
                    traffic = point.traffic_2015;
                } else if (currentMode === '2021') {
                    traffic = point.traffic_2021;
                } else {
                    traffic = point.traffic_2021;
                }
                
                color = getTrafficColor(traffic);
                radius = getTrafficRadius(traffic);
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                if (currentMode === 'comparison') {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'center';
                    const changeText = point.change >= 0 ? `+${point.change}` : `${point.change}`;
                    ctx.fillText(changeText, x, y + radius + 12);
                }
            });
        }
        
        function getPointAtPosition(x, y) {
            const center = latLonToPixel(centerLat, centerLon, zoom);
            
            for (const point of comparisonData) {
                const pos = latLonToPixel(point.lat, point.lon, zoom);
                const screenX = (pos.x - center.x) + canvas.width / 2 + offsetX;
                const screenY = (pos.y - center.y) + canvas.height / 2 + offsetY;
                
                let traffic = currentMode === '2015' ? point.traffic_2015 : point.traffic_2021;
                const radius = getTrafficRadius(traffic);
                
                const distance = Math.sqrt(Math.pow(x - screenX, 2) + Math.pow(y - screenY, 2));
                if (distance <= radius + 5) {
                    return point;
                }
            }
            return null;
        }
        
        function showTooltip(point, x, y) {
            let html = `<div class="tooltip-title">${point.road_name}</div>`;
            
            if (currentMode === 'comparison') {
                html += `
                    <div class="tooltip-row">
                        <span class="tooltip-label">2015Âπ¥:</span>
                        <span class="tooltip-value">${point.traffic_2015.toLocaleString()}Âè∞/Êó•</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">2021Âπ¥:</span>
                        <span class="tooltip-value">${point.traffic_2021.toLocaleString()}Âè∞/Êó•</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Â§âÂåñ:</span>
                        <span class="tooltip-value change-negative">
                            ${point.change >= 0 ? '+' : ''}${point.change.toLocaleString()}Âè∞ (${point.change_rate >= 0 ? '+' : ''}${point.change_rate}%)
                        </span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">ËªäÁ∑öÊï∞:</span>
                        <span class="tooltip-value">${point.lanes}ËªäÁ∑ö</span>
                    </div>
                `;
                
                if (point.small_car_2015) {
                    html += `
                        <div class="tooltip-row">
                            <span class="tooltip-label">Â∞èÂûãËªä(2015/2021):</span>
                            <span class="tooltip-value">${point.small_car_2015.toLocaleString()} / ${point.small_car_2021.toLocaleString()}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Â§ßÂûãËªä(2015/2021):</span>
                            <span class="tooltip-value">${point.large_car_2015.toLocaleString()} / ${point.large_car_2021.toLocaleString()}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Ê∑∑ÈõëÊôÇÈÄüÂ∫¶(‰∏ã„Çä):</span>
                            <span class="tooltip-value">${point.speed_down_2015} ‚Üí ${point.speed_down_2021} km/h</span>
                        </div>
                    `;
                }
                
                if (point.data_type === 'estimated') {
                    html += `<div class="data-note">‚Äª Êé®ÂÆöÂÄ§„ÇíÂê´„Åø„Åæ„Åô</div>`;
                }
            } else {
                const year = currentMode === '2015' ? 2015 : 2021;
                const traffic = currentMode === '2015' ? point.traffic_2015 : point.traffic_2021;
                
                html += `
                    <div class="tooltip-row">
                        <span class="tooltip-label">24ÊôÇÈñì‰∫§ÈÄöÈáè:</span>
                        <span class="tooltip-value">${traffic.toLocaleString()}Âè∞/Êó•</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">ËªäÁ∑öÊï∞:</span>
                        <span class="tooltip-value">${point.lanes}ËªäÁ∑ö</span>
                    </div>
                `;
                
                if (point.data_type === 'estimated') {
                    html += `<div class="data-note">‚Äª Êé®ÂÆöÂÄ§„ÇíÂê´„Åø„Åæ„Åô</div>`;
                }
            }
            
            tooltip.innerHTML = html;
            tooltip.style.left = (x + 15) + 'px';
            tooltip.style.top = (y - 10) + 'px';
            tooltip.style.display = 'block';
        }
        
        function hideTooltip() {
            tooltip.style.display = 'none';
        }
        
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStartX = e.clientX - offsetX;
            dragStartY = e.clientY - offsetY;
            canvas.style.cursor = 'grabbing';
        });
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (isDragging) {
                offsetX = e.clientX - dragStartX;
                offsetY = e.clientY - dragStartY;
                draw();
                hideTooltip();
            } else {
                const point = getPointAtPosition(x, y);
                if (point) {
                    canvas.style.cursor = 'pointer';
                    showTooltip(point, e.clientX, e.clientY);
                } else {
                    canvas.style.cursor = 'move';
                    hideTooltip();
                }
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = 'move';
            
            const center = latLonToPixel(centerLat, centerLon, zoom);
            const newCenter = pixelToLatLon(center.x - offsetX, center.y - offsetY, zoom);
            centerLat = newCenter.lat;
            centerLon = newCenter.lon;
            offsetX = 0;
            offsetY = 0;
        });
        
        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            canvas.style.cursor = 'move';
            hideTooltip();
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -1 : 1;
            const newZoom = Math.max(10, Math.min(18, zoom + delta));
            if (newZoom !== zoom) {
                zoom = newZoom;
                draw();
            }
        });
        
        document.getElementById('yearSelect').addEventListener('change', (e) => {
            currentMode = e.target.value;
            draw();
        });
        
        function zoomIn() {
            if (zoom < 18) {
                zoom++;
                draw();
            }
        }
        
        function zoomOut() {
            if (zoom > 10) {
                zoom--;
                draw();
            }
        }
        
        function resetView() {
            zoom = 14;
            centerLat = 35.7175;
            centerLon = 139.7525;
            offsetX = 0;
            offsetY = 0;
            draw();
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    </script>
</body>
</html>
